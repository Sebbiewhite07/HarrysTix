# Preâ€‘Order Ticket Management System â€“ Product Requirements Document

**Product**: Harryâ€™s Tix â€“ Admin Dashboard, Backend Services & Memberâ€‘Facing Portal
**Version**: 2.0Â Â (JulyÂ 2025)
**Authors**: Product & Platform Team
**Status**: Draft for stakeholder signâ€‘off

---

## 1Â Â Product Vision

Automate and deâ€‘risk the allocation of bulkâ€‘uploaded event tickets to prepaid member orders, delivering tickets to students within minutes of upload while giving admins realâ€‘time insight into stock, variant mismatches, and fulfilment health.

**Success Metrics**

| Metric                                            | Target                   | Rationale                          |
| ------------------------------------------------- | ------------------------ | ---------------------------------- |
| â±Â Median time from CSV upload â†’ ticket email sent | **<â€¯2â€¯min**              | Delight users; reduce support load |
| ğŸ”„ Autoâ€‘assignment success rate                   | **â‰¥â€¯95â€¯%**               | Keep manual intervention rare      |
| ğŸ“§ Delivery failure rate                          | **<â€¯0.5â€¯%**              | Maintain trust & inbox placement   |
| ğŸ“Š Dashboard P95 load time                        | **<â€¯1â€¯s** at 10â€¯k events | Admin productivity                 |

---

## 2Â Â User Personas

* **Club Member (Student, 18â€‘25)** â€“ Buys 1 ticket per event, expects seamless delivery.
* **Event Admin (Internal)** â€“ Uploads ticket CSVs, monitors fulfilment, handles edgeâ€‘cases.
* **Support Agent** â€“ Resends tickets, audits assignment logs.

---

## 3Â Â Key Concepts & Domain Model

| Entity         | Description                                                                                       |
| -------------- | ------------------------------------------------------------------------------------------------- |
| **PreOrder**   | Paid reservation for a ticket prior to upload. One per user per event; carries desired *Variant*. |
| **Variant**    | Subâ€‘category inside an event (e.g. *EntryÂ 9â€‘9â€¯:â€¯30â€¯pm*). Optional.                                |
| **Ticket**     | Final credential (EmailÂ +Â Password or QR). Uploaded in bulk CSV.                                  |
| **Assignment** | Link table mapping a *Ticket* â†’ *PreOrder* (1â€‘toâ€‘1). Stores timestamps & actor.                   |

---

## 4Â Â Endâ€‘toâ€‘End Lifecycle

1. **Preâ€‘Order WindowÂ &Â PaymentÂ Capture** â€“ Members place orders; the platform **attempts to capture the full ticket amount offâ€‘session every Tuesday at 19â€¯:â€¯00**.

   * If **`payment_intent.succeeded`** is received, the preâ€‘order row moves to `confirmed`.
   * If the card authorises but the capture fails (insufficient funds, card expired, etc.), the row stays `processing` and later becomes `failed`; **no ticket is ever allocated until payment succeeds.**
2. **CSV Upload** â€“ Admin drags `.csv`; system validates/ingests rows â†’ `tickets.unassigned`.
3. **Autoâ€‘Assignment** â€“ Realâ€‘time worker matches tickets to the earliest matching `pre_orders.confirmed` using *event\_id*Â +Â *variant* (or *any variant* fallback if enabled). **The worker is triggered by two events:** (a) a new CSV ticket upload, or (b) a Stripe `payment_intent.succeeded` webhook when matching unassigned tickets already exist.
4. **Fulfilment** â€“ Email sent; dashboard & user portal update; audit log written.
5. **Exceptions** â€“ Unmatched tickets flagged; unmatched preâ€‘orders move to `waiting_for_stock`; support tools available.

---

## 5Â Â Functional Requirements

### 5.1Â Â Member Preâ€‘Order UX

* **Variant picker** (dropdown) appears when event has variants.
* Enforce *1 preâ€‘order / event* rule via backend validation.
* Postâ€‘charge statuses shown:

  * *Processing* â€“ payment complete, awaiting ticket
  * *Fulfilled* â€“ ticket assigned, link to credentials
  * *Waiting for Ticket* â€“ no stock yet (tooltip explains)

### 5.2Â Â Admin CSV Upload

1. **Upload Panel**

   * Dragâ€‘andâ€‘drop or file chooser
   * Realtime preview (firstÂ 20 rows)
2. **Validation Rules**

   * CSV headers exactly `Event,Variant,Email,Password`
   * Duplicate `(Event,Email,Password)` rows rejected
   * Row limitÂ â‰¤Â 10â€¯k; sizeÂ â‰¤Â 5â€¯MB
3. **Confirmation Screen** shows:

   * Total rows, rows valid, duplicates, malformed
   * Variant coverage vs preâ€‘order demand
4. **Commit** button triggers storage & assignment worker.

### 5.3Â Â Autoâ€‘Assignment Engine

```mermaid
graph TD
  A[Ticket uploaded] --> B{Matching Preâ€‘Order?}
  B -- Yes --> C[Assign + email]
  B -- No --> D[Mark ticket unmatched]
```

* FIFO by `pre_orders.confirmed_at` ensures fairness.
* All actions wrapped in DB transaction; Redis lock on `(event_id,variant)` prevents raceâ€‘conditions when multiple CSVs land.
* Fallback logic (toggle per event): if variant mismatch, allow *closest time* variant using Jaccard similarity on interval.

### 5.4Â Â Admin Dashboard 2.0

* **Overview Cards** â€“ orders, tickets, fulfilment %, unmatched counts.
* **Variant Matrix** â€“ heatâ€‘map cells show *ordered vs. uploaded* by variant.
* **Smart Filters** â€“ status, user, email, variant.
* **Bulk Actions** â€“ resend email, mark ticket used, export CSV.

### 5.5Â Â Email Automation

* Template stored in Postmark; variables: `event_name`, `variant`, `ticket_email`, `ticket_password`.
* **Dispatch Condition** â€“ Email is sent **only after** Stripe confirms the charge (`payment_intent.succeeded`) **and** a ticket has been successfully assigned to the preâ€‘order.
* Retry up to 3Ã— on transient SMTP errors.
* Webhook updates `delivery_status` in `assignments` table for observability.

---

## 6Â Â Nonâ€‘Functional Requirements

| Category         | Requirement                                                                            |
| ---------------- | -------------------------------------------------------------------------------------- |
| **Performance**  | Bulk upload of 10â€¯k tickets processed in **<â€¯60â€¯s**                                    |
| **Scalability**  | Support 100 concurrent uploads; assignment worker horizontally scalable (Redis queue). |
| **Security**     | Ticket passwords stored AESâ€‘256; access limited to assigned user and support role.     |
| **Auditability** | All state transitions recorded in `assignment_logs` table with actor & IP.             |
| **Compliance**   | GDPR: Rightâ€‘toâ€‘erasure removes *Ticket*, *Assignment* rows and masks email in logs.    |

---

## 7Â Â Data Model Updates (DrizzleÂ ORM)

```ts
export const tickets = pgTable('tickets', {
  id: uuid('id').primaryKey(),
  eventId: uuid('event_id').references(() => events.id),
  variant: text('variant'),
  email: text('email'),
  password: text('password').secret(),
  status: text('status', { enum: ['unassigned','assigned','unmatched','used']}).default('unassigned'),
  assignedUserId: uuid('assigned_user_id').references(() => users.id),
  assignedAt: timestamp('assigned_at'),
  createdAt: timestamp('created_at').defaultNow()
});

export const assignments = pgTable('ticket_assignments', {
  id: uuid('id').primaryKey(),
  ticketId: uuid('ticket_id').references(() => tickets.id),
  preOrderId: uuid('pre_order_id').references(() => preOrders.id),
  status: text('status', { enum: ['sent','delivery_failed']}).default('sent'),
  createdAt: timestamp('created_at').defaultNow()
});
```

---

## 8Â Â API Surface (REST / tRPC)

| Method | Path                                      | Description                 |
| ------ | ----------------------------------------- | --------------------------- |
| `POST` | `/api/admin/tickets/upload`               | Receive CSV â†’ job queue     |
| `GET`  | `/api/admin/tickets/assignments?eventId=` | Paginated list              |
| `POST` | `/api/admin/tickets/:id/resend`           | Resend email                |
| `POST` | `/api/admin/events/:id/reconcile`         | Reâ€‘run assignment algorithm |
| `GET`  | `/api/me/pre-orders`                      | Member dashboard data       |

---

## 9Â Â Observability & Alerting

* **Metrics** via Promâ€‘client:

  * `ticket_assignment_duration_seconds{status}` histogram
  * `unmatched_tickets_total` gauge (per event)
* **Dashboards** in Grafana; alert when unmatchedâ€¯>â€¯(5Â %Â of preâ€‘orders) 15Â min after upload.

---

## 10Â Â Risks & Mitigations

| Risk                | Impact             | Mitigation                                                              |
| ------------------- | ------------------ | ----------------------------------------------------------------------- |
| Variant typo in CSV | Tickets unmatched  | Add fuzzyâ€‘match preview + admin correction UI                           |
| Email spam filters  | Users miss tickets | Use branded sending domain + SPF/DKIM, monitor Postmark bounce webhooks |
| Oversold event      | Refund workload    | Future *overbooking feature* with prioritised waitlist + autoâ€‘refund    |

---

## 11Â Â Phased Build Roadmap

| Phase                       | Window                 | Objective                                                     | Major Deliverables                                                                                                                                                                                                               |
| --------------------------- | ---------------------- | ------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **1Â â€“Â CoreÂ MVP**            | **NowÂ â†’Â 12â€¯Augâ€¯2025**  | Ship automated preâ€‘order fulfilment for initial event volume. | â€¢ Ticket & assignment schema<br>â€¢ CSV upload UI with validation<br>â€¢ Assignment worker (uploadâ€‘ & webhookâ€‘triggered)<br>â€¢ Stripe capture cron + idempotent webhooks<br>â€¢ Basic metrics & structured logs<br>â€¢ Admin dashboard v1 |
| **2Â â€“Â ScaleÂ &Â Reliability** | **SepÂ â†’Â Octâ€¯2025**     | Handle 10Ã— traffic with zeroâ€‘touch Tuesday processing.        | â€¢ Cronâ€‘based capture + assignment<br>â€¢ Horizontal queue scaling (BullMQÂ +Â Redis)<br>â€¢ Grafana dashboards & PagerDuty alerts<br>â€¢ Roleâ€‘based support tools (resend, refund)<br>â€¢ Accessibility / WCAG audit fixes                 |
| **3Â â€“Â PremiumÂ &Â Advanced**  | **Novâ€¯2025Â â†’Â Q1â€¯2026** | Unlock growth & premium workflows.                            | â€¢ Manual dragâ€‘drop reassignment UI<br>â€¢ Waitlist autoâ€‘fill & overbooking refunds<br>â€¢ Variant clustering / â€œclosest timeâ€ matcher<br>â€¢ Mobile push notifications for ticket delivery<br>â€¢ Public API for partner integrations    |

---

## 12Â Â Future Enhancements

* Manual dragâ€‘drop reassignment tool
* Waitlist autoâ€‘fill & refund workflows
* Mobile push notifications for ticket delivery
* Variant clustering by time window (e.g. Â±15â€¯min)

---

> *â€œGet the right ticket to the right student, every time, in under two minutes.â€* â€“ Product Motto
